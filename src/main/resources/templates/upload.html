<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{upload.title}">NextGen File Upload</title>

    <!-- 구글 폰트와 폰트어썸 라이브러리 링크를 포함하여 웹 페이지의 폰트와 아이콘 스타일을 설정 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Font Awesome -->

    <!-- 페이지의 스타일을 정의하는 CSS -->
    <style>
        :root {
            --primary-color: #4a90e2; /* 주 색상 */
            --secondary-color: #f2f2f2; /* 보조 색상 */
            --text-color: #333; /* 텍스트 색상 */
            --success-color: #28a745; /* 성공 색상 */
            --error-color: #dc3545; /* 에러 색상 */
            --light-primary-color: #ffa726; /* 밝은 주 색상 */
            --progress-background-color: #d3d3d3; /* 진행바 배경 색상 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif; /* 글꼴 설정 */
            color: var(--text-color); /* 텍스트 색상 */
            min-height: 100vh; /* 최소 높이 */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: white; /* 배경 색상 */
            border-radius: 20px; /* 테두리 둥글게 */
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22); /* 그림자 효과 */
            padding: 2rem; /* 내부 여백 */
            width: 90%; /* 너비 설정 */
            max-width: 600px; /* 최대 너비 */
            text-align: center; /* 중앙 정렬 */
            margin: auto; /* 수평 중앙 정렬 */
            display: flex; /* Flexbox 사용 */
            flex-direction: column; /* Flexbox 방향 */
            align-items: center; /* 수직 중앙 정렬 */
            justify-content: center; /* 수직 중앙 정렬 */
            transition: height 0.5s ease, max-height 0.5s ease, padding 0.5s ease, margin 0.5s ease; /* 트랜지션 효과 */
            overflow: hidden; /* 내용이 넘칠 때 숨기기 */
            max-height: 600px; /* 최대 높이 설정 */
        }

        h1 {
            color: var(--primary-color); /* 제목 색상 */
            margin-bottom: 2rem; /* 아래 여백 */
            font-weight: 500; /* 폰트 두께 */
        }

        #uploadForm {
            display: flex; /* Flexbox 사용 */
            flex-direction: column; /* Flexbox 방향 */
            align-items: center; /* 수직 중앙 정렬 */
        }

        .file-input-wrapper {
            position: relative; /* 위치 설정 */
            overflow: visible; /* 넘침 표시 */
            display: inline-block; /* 인라인 블록 */
            cursor: pointer; /* 커서 설정 */
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px; /* 글꼴 크기 */
            position: absolute; /* 절대 위치 */
            left: 0; /* 왼쪽 위치 */
            top: 0; /* 상단 위치 */
            opacity: 0; /* 투명도 */
            cursor: pointer; /* 커서 설정 */
        }

        .file-input-wrapper .btn {
            display: inline-block; /* 인라인 블록 */
            padding: 12px 24px; /* 내부 여백 */
            background-color: var(--primary-color); /* 배경 색상 */
            color: white; /* 텍스트 색상 */
            border: none; /* 테두리 없음 */
            border-radius: 30px; /* 테두리 둥글게 */
            font-size: 1rem; /* 폰트 크기 */
            transition: all 0.3s ease; /* 트랜지션 효과 */
            cursor: pointer; /* 커서 설정 */
        }

        .file-input-wrapper .btn,
        #uploadBtn {
            display: inline-block; /* 인라인 블록 */
            padding: 12px 24px; /* 내부 여백 */
            background-color: var(--light-primary-color); /* 밝은 색상 적용 */
            color: white; /* 텍스트 색상 */
            border: none; /* 테두리 없음 */
            border-radius: 30px; /* 테두리 둥글게 */
            font-size: 1rem; /* 폰트 크기 */
            transition: all 0.3s ease; /* 트랜지션 효과 */
            cursor: pointer; /* 커서 설정 */
        }

        .file-input-wrapper .btn:hover,
        #uploadBtn:hover {
            background-color: #3a7bd5; /* 배경 색상 변경 */
            transform: translateY(-2px); /* 위치 이동 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
        }

        #uploadBtn {
            margin-top: 1rem; /* 위 여백 */
            padding: 12px 24px; /* 내부 여백 */
            background-color: var(--success-color); /* 배경 색상 */
            color: white; /* 텍스트 색상 */
            border: none; /* 테두리 없음 */
            border-radius: 30px; /* 테두리 둥글게 */
            font-size: 1rem; /* 폰트 크기 */
            transition: all 0.3s ease; /* 트랜지션 효과 */
            cursor: pointer; /* 커서 설정 */
            display: none; /* 기본적으로 숨김 */
        }

        #fileList {
            list-style-type: none; /* 리스트 스타일 없음 */
            padding: 0; /* 내부 여백 없음 */
            margin-top: 2rem; /* 위 여백 */
            max-height: 200px; /* 파일 리스트 최대 높이 설정 */
            overflow-y: auto; /* 세로 스크롤 */
            width: 100%; /* 너비 설정 */
            transition: all 0.3s ease; /* 트랜지션 효과 */
        }

        #fileList li {
            background-color: var(--secondary-color); /* 배경 색상 */
            margin: 0.5rem 0; /* 위아래 여백 */
            padding: 1rem; /* 내부 여백 */
            border-radius: 8px; /* 테두리 둥글게 */
            display: flex; /* Flexbox 사용 */
            justify-content: space-between; /* 공간 분배 */
            align-items: center; /* 수직 중앙 정렬 */
            transition: all 0.3s ease; /* 트랜지션 효과 */
        }

        #fileList li:hover {
            transform: translateY(-2px); /* 위치 이동 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
        }

        .remove-file {
            color: var(--error-color); /* 텍스트 색상 */
            cursor: pointer; /* 커서 설정 */
            transition: all 0.3s ease; /* 트랜지션 효과 */
        }

        .remove-file:hover {
            transform: scale(1.2); /* 확대 */
        }


        .progress-bar {
            width: 100%; /* 너비 설정 */
            height: 15px; /* 높이 설정 */
            background: rgba(255, 255, 255, 0.1); /* 배경 색상 */
            border-radius: 10px; /* 테두리 둥글게 */
            margin-top: 1rem; /* 위 여백 */
            overflow: hidden; /* 넘침 숨기기 */
            backdrop-filter: blur(10px); /* 유리 효과 */
            -webkit-backdrop-filter: blur(10px); /* 유리 효과 */
            box-shadow: inset 0 4px 6px rgba(0, 0, 0, 0.1), /* 안쪽 그림자 효과 */ 0 2px 4px rgba(0, 0, 0, 0.2); /* 바깥 그림자 효과 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* 경계선 */
        }

        .progress {
            width: 0%; /* 너비 초기화 */
            height: 100%; /* 높이 설정 */
            background: linear-gradient(to right, rgba(74, 144, 226, 0.8), rgba(74, 144, 226, 1)); /* 배경 그라데이션 */
            transition: width 0.5s ease; /* 트랜지션 효과 */
            border-radius: 10px; /* 테두리 둥글게 */
            box-shadow: inset 0 2px 5px rgba(255, 255, 255, 0.3), /* 안쪽 그림자 효과 */ 0 2px 4px rgba(0, 0, 0, 0.2); /* 바깥 그림자 효과 */
        }

        #message {
            margin-top: 1rem; /* 위 여백 */
            padding: 1rem; /* 내부 여백 */
            border-radius: 8px; /* 테두리 둥글게 */
            font-weight: bold; /* 폰트 두께 */
            display: none; /* 기본적으로 숨김 */
            transition: opacity 0.5s ease, max-height 0.5s ease, padding 0.5s ease, margin-top 0.5s ease; /* 트랜지션 효과 */
        }

        .success {
            background-color: #d4edda; /* 배경 색상 */
            color: var(--success-color); /* 텍스트 색상 */
        }

        .error {
            background-color: #f8d7da; /* 배경 색상 */
            color: var(--error-color); /* 텍스트 색상 */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            /* 초기 투명도 */
            to {
                opacity: 1;
            }
            /* 최종 투명도 */
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in; /* 페이드 인 애니메이션 */
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out; /* 페이드 아웃 애니메이션 */
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            /* 초기 투명도 */
            to {
                opacity: 0;
            }
            /* 최종 투명도 */
        }

        @media (max-width: 600px) {
            .container {
                width: 95%; /* 너비 설정 */
                padding: 1rem; /* 내부 여백 */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-cloud-upload-alt"></i> <span th:text="#{upload.title}">MetroCount Data File Upload</span></h1>

    <!-- 파일 업로드 폼: 파일 선택 버튼과 업로드 버튼을 포함 -->
    <form id="uploadForm">
        <div class="file-input-wrapper">
            <label class="btn" for="fileInput"><i class="fas fa-folder-open"></i> <span th:text="#{upload.chooseFiles}">Choose Files</span></label> <!-- 파일 선택 버튼 -->
            <input type="file" id="fileInput" multiple style="display: none;"/> <!-- 파일 입력 -->
        </div>
        <button type="submit" id="uploadBtn" title="Select files to upload"><i class="fas fa-upload"></i> <span th:text="#{upload.uploadFiles}">Upload Files</span></button> <!-- 업로드 버튼 -->
    </form>

    <!-- 선택된 파일 목록을 보여주는 리스트 -->
    <ul id="fileList"></ul> <!-- 파일 리스트 -->

    <!-- 업로드 진행률을 보여주는 프로그레스 바 -->
    <div class="progress-bar">
        <div class="progress"></div> <!-- 진행 바 -->
    </div>

    <!-- 메시지를 보여주는 요소: 업로드 성공 또는 실패 메시지 -->
    <div id="message"></div> <!-- 메시지 표시 영역 -->
</div>

<script>
    let fileListArray = []; // 선택된 파일 목록을 저장하는 배열
    const fileInput = document.getElementById('fileInput'); // 파일 입력 요소
    const uploadBtn = document.getElementById('uploadBtn'); // 업로드 버튼
    const fileList = document.getElementById('fileList'); // 파일 리스트 요소
    const progressBar = document.querySelector('.progress'); // 진행 바 요소
    const message = document.getElementById('message'); // 메시지 표시 요소

    fileInput.addEventListener('change', handleFileSelect); // 파일 선택 시 이벤트 리스너
    document.getElementById('uploadForm').addEventListener('submit', handleUpload); // 폼 제출 시 이벤트 리스너

    /**
     * 파일 선택 시 호출되는 함수
     * 선택된 파일을 배열에 추가하고 파일 목록을 업데이트
     */
    // 수정된 handleFileSelect 함수
    function handleFileSelect(event) {
        try {
            const files = Array.from(event.target.files); // 선택된 파일들을 배열로 변환
            const maxFileSize = 100 * 1024 * 1024; // 개별 파일 크기 제한: 100MB
            const maxTotalSize = 100 * 1024 * 1024; // 총 파일 크기 제한: 100MB
            let totalSize = fileListArray.reduce((acc, file) => acc + file.size, 0); // 현재 선택된 파일들의 총 크기 계산

            // 개별 파일 크기 제한을 초과하는 파일 필터링
            const oversizedFiles = files.filter(file => file.size > maxFileSize);
            if (oversizedFiles.length > 0) {
                showMessage('Some files exceed the 100MB size limit and will not be added.', 'error'); // 경고 메시지 표시
            }

            // 개별 파일 크기 제한을 초과하지 않는 파일 필터링
            const validFiles = files.filter(file => file.size <= maxFileSize);

            // 중복 파일 필터링
            const duplicateFiles = validFiles.filter(file =>
                fileListArray.some(existingFile => existingFile.name === file.name)
            );
            if (duplicateFiles.length > 0) {
                showMessage('Duplicate files detected. They will not be added.', 'error'); // 경고 메시지 표시
            }

            // 중복되지 않는 새 파일 필터링
            const newFiles = validFiles.filter(file =>
                !fileListArray.some(existingFile => existingFile.name === file.name)
            );

            // 새 파일들의 크기를 총 크기에 더함
            newFiles.forEach(file => totalSize += file.size);

            // 총 파일 크기가 제한을 초과하는지 확인
            if (totalSize > maxTotalSize) {
                showMessage('Total file size exceeds the 10MB limit. Some files will not be added.', 'error'); // 경고 메시지 표시
            } else {
                fileListArray = fileListArray.concat(newFiles); // 새 파일들을 선택된 파일 배열에 추가
            }

            updateFileList(); // 파일 목록 업데이트
            updateUploadButton(); // 업로드 버튼 상태 업데이트
            event.target.value = ''; // 파일 입력 요소 초기화
        } catch (error) {
            showMessage('An error occurred while selecting files. Please try again.', 'error'); // 예외 발생 시 경고 메시지 표시
        }
    }

    /**
     * 파일 목록을 업데이트하는 함수
     */
    function updateFileList() {
        try {
            fileList.innerHTML = ''; // 파일 리스트 초기화
            fileListArray.forEach((file, index) => {
                const li = document.createElement('li'); // 새로운 리스트 항목 생성
                li.className = 'fade-in'; // 페이드 인 클래스 추가
                li.innerHTML = `
                    <span>${file.name}</span>
                    <i class="fas fa-times remove-file" data-index="${index}"></i>
                `; // 파일 이름과 제거 버튼 추가
                fileList.appendChild(li); // 파일 리스트에 추가
            });

            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', removeFile); // 제거 버튼 클릭 시 이벤트 리스너 추가
            });

            adjustContainerHeight(); // 컨테이너 높이 조정
        } catch (error) {
            showMessage('An error occurred while updating the file list. Please try again.', 'error'); // 예외 발생 시 경고 메시지 표시
        }
    }

    /**
     * 파일 목록에서 파일을 제거하는 함수
     */
    function removeFile(event) {
        try {
            const index = event.target.dataset.index; // 클릭된 파일 인덱스 가져오기
            fileListArray.splice(index, 1); // 파일 배열에서 제거
            updateFileList(); // 파일 목록 업데이트
            updateUploadButton(); // 업로드 버튼 상태 업데이트
        } catch (error) {
            showMessage('An error occurred while removing the file. Please try again.', 'error'); // 예외 발생 시 경고 메시지 표시
        }
    }

    /**
     * 업로드 버튼의 상태를 업데이트하는 함수
     */
    function updateUploadButton() {
        try {
            uploadBtn.style.display = fileListArray.length === 0 ? 'none' : 'inline-block'; // 파일이 없으면 숨기고, 있으면 표시
            uploadBtn.title = fileListArray.length === 0 ? "Select files to upload" : "Click to upload selected files"; // 툴팁 설정
        } catch (error) {
            showMessage('An error occurred while updating the upload button. Please try again.', 'error'); // 예외 발생 시 경고 메시지 표시
        }
    }

    /**
     * 파일 업로드를 처리하는 함수
     */
    function handleUpload(event) {
        event.preventDefault(); // 기본 폼 제출 동작 방지

        try {
            if (fileListArray.length === 0) {
                showMessage('Please select at least one file to upload.', 'error'); // 파일이 없을 때 메시지 표시
                return;
            }

            const formData = new FormData(); // 폼 데이터 객체 생성
            fileListArray.forEach(file => {
                formData.append('files', file); // 폼 데이터에 파일 추가
            });

            uploadFiles(formData); // 파일 업로드 함수 호출
        } catch (error) {
            showMessage('An error occurred while preparing the upload. Please try again.', 'error'); // 예외 발생 시 경고 메시지 표시
        }
    }

    /**
     * 파일을 서버에 업로드하는 함수
     */
    function uploadFiles(formData) {
        try {
            const xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성
            xhr.open('POST', '/upload', true); // POST 요청 설정

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100; // 업로드 진행률 계산
                    progressBar.style.width = percentComplete + '%'; // 진행 바 너비 설정
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    showMessage('Files uploaded successfully!', 'success'); // 업로드 성공 메시지 표시
                    fileListArray = []; // 파일 목록 초기화
                    updateFileList(); // 파일 목록 업데이트
                    updateUploadButton(); // 업로드 버튼 상태 업데이트
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 2000); // 진행 바 초기화
                } else {
                    showMessage('File upload failed. Please try again.', 'error'); // 업로드 실패 메시지 표시
                }
            };

            xhr.onerror = function () {
                showMessage('An error occurred during the upload. Please try again.', 'error'); // 업로드 에러 메시지 표시
            };

            xhr.send(formData); // 폼 데이터 전송
        } catch (error) {
            showMessage('An error occurred while uploading the files. Please try again.', 'error'); // 예외 발생 시 경고 메시지 표시
        }
    }

    /**
     * 메시지를 보여주는 함수
     */
    function showMessage(text, type) {
        message.textContent = text; // 메시지 텍스트 설정
        message.className = type; // 메시지 클래스 설정
        message.style.display = 'block'; // 메시지 표시
        message.classList.add('fade-in'); // 페이드 인 클래스 추가
        message.style.opacity = '1'; // 초기 투명도 설정
        message.style.maxHeight = '100px'; // 초기 최대 높이 설정
        message.style.padding = '1rem'; // 초기 패딩 설정
        message.style.marginTop = '1rem'; // 초기 마진 설정

        setTimeout(() => {
            message.classList.remove('fade-in'); // 페이드 인 클래스 제거
            message.classList.add('fade-out'); // 페이드 아웃 클래스 추가
            message.style.opacity = '0'; // 투명도 0으로 설정
            message.style.maxHeight = '0'; // 높이 0으로 설정
            message.style.padding = '0'; // 패딩 0으로 설정
            message.style.marginTop = '0'; // 마진 0으로 설정
            setTimeout(() => {
                message.style.display = 'none'; // 메시지 숨기기
                message.classList.remove('fade-out'); // 페이드 아웃 클래스 제거
                message.style.opacity = ''; // 초기 상태로 되돌림
                message.style.maxHeight = ''; // 초기 상태로 되돌림
                message.style.padding = ''; // 초기 상태로 되돌림
                message.style.marginTop = ''; // 초기 상태로 되돌림
            }, 500); // 트랜지션 효과 시간과 동일하게 설정
        }, 3000); // 메시지 표시 시간을 3000ms로 설정
    }

    /**
     * 컨테이너의 높이를 파일 리스트 크기에 맞춰 동적으로 조정하는 함수
     */
    function adjustContainerHeight() {

        const container = document.querySelector('.container'); // 컨테이너 요소 가져오기
        const fileListHeight = fileList.scrollHeight; // 파일 리스트 높이 가져오기
        container.style.height = Math.min(fileListHeight + 300, 500) + 'px'; // 추가 여백을 고려하여 높이 설정, 최대 높이 500px
    }

    // 초기 로드 시 컨테이너 높이 설정
    document.addEventListener('DOMContentLoaded', adjustContainerHeight);

    // 파일 추가 및 제거 시 높이 조정
    fileInput.addEventListener('change', adjustContainerHeight);
    fileList.addEventListener('DOMNodeInserted', adjustContainerHeight);
    fileList.addEventListener('DOMNodeRemoved', adjustContainerHeight);

</script>
</body>
</html>
